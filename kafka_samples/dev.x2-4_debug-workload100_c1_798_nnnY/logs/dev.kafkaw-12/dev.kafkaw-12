#
# Generated by omcli
# Cluster:dev.x2-4 Node:dev.x2-4.kafkaw-2
#
cat << 'HOSTS' > omhosts
# Generated by omcli

192.168.10.11  dev.kafkaui-5
192.168.10.11  dev.x2-4.kafkaui-1.ctrl-0
192.168.104.1  dev.x2-4.kafkaui-1.ext-0
192.168.10.61  dev.kafkaw-04
192.168.10.61  dev.x2-4.kafkaw-1.ctrl-0
192.168.104.6  dev.x2-4.kafkaw-1.ext-0
192.168.10.71  dev.kafkaw-12
192.168.10.71  dev.x2-4.kafkaw-2.ctrl-0
192.168.104.7  dev.x2-4.kafkaw-2.ext-0
192.168.10.11  dev.rdpui-5
192.168.10.11  dev.x2-4.rdpui-1.ctrl-0
192.168.104.1  dev.x2-4.rdpui-1.ext-0
192.168.10.21  dev.x2-17
192.168.10.21  dev.x2-4.x2-0.ctrl-0
192.168.104.2  dev.x2-4.x2-0.ext-0
192.168.214.2  dev.x2-4.x2-0.ib-0
192.168.204.2  dev.x2-4.x2-0.int-0
192.168.10.31  dev.x2-18
192.168.10.31  dev.x2-4.x2-1.ctrl-0
192.168.104.3  dev.x2-4.x2-1.ext-0
192.168.214.3  dev.x2-4.x2-1.ib-0
192.168.204.3  dev.x2-4.x2-1.int-0
192.168.10.41  dev.x2-19
192.168.10.41  dev.x2-4.x2-2.ctrl-0
192.168.104.4  dev.x2-4.x2-2.ext-0
192.168.214.4  dev.x2-4.x2-2.ib-0
192.168.204.4  dev.x2-4.x2-2.int-0
192.168.10.51  dev.x2-20
192.168.10.51  dev.x2-4.x2-3.ctrl-0
192.168.104.5  dev.x2-4.x2-3.ext-0
192.168.214.5  dev.x2-4.x2-3.ib-0
192.168.204.5  dev.x2-4.x2-3.int-0
192.168.10.11  dev.x2w-08
192.168.10.11  dev.x2-4.x2w-1.ctrl-0
192.168.104.1  dev.x2-4.x2w-1.ext-0
HOSTS
cat omhosts | sudo tee /etc/hosts &> /dev/null
#!/usr/bin/env bash
#!/usr/bin/env bash
#
cat << 'EOF' >workers.yaml
workers:
  - http://dev.x2-4.kafkaw-1.ctrl-0:1080
  - http://dev.x2-4.kafkaw-2.ctrl-0:1130
EOF
#
function configure_driver {
DRIVER_FILES=$(ls -1 /opt/benchmark/driver-kafka/*.yaml)
for FILE in $DRIVER_FILES; do
  sed -i "s/^  bootstrap.servers=.*$/  bootstrap.servers=dev.x2-4.x2-3.ext-0:1558/g" $FILE
done
}
#
function configure_jms {
JMS_FILES=$(ls -1 /opt/benchmark/driver-jms/*.yaml)
for FILE in $JMS_FILES; do
  sed -i "s/^  bootstrap.servers=.*$/  bootstrap.servers=dev.x2-4.x2-3.ext-0:1558/g" $FILE
  sed -i "s/localhost:9092/dev.x2-4.x2-3.ext-0:1558/g" $FILE
done
}
#
function configure_worker_memory {
sed -i 's/^JVM_MEM=.*$/JVM_MEM=" -Xms24G -Xmx24G -XX:+UnlockExperimentalVMOptions -XX:+UseZGC -XX:+ParallelRefProcEnabled -XX:+DoEscapeAnalysis -XX:ParallelGCThreads=8 -XX:ConcGCThreads=4 -XX:+DisableExplicitGC -XX:-ResizePLAB -XX:+UseContainerSupport -XX:MaxRAMPercentage=75 -XX:+AlwaysPreTouch -XX:ZAllocationSpikeTolerance=5"/g' /opt/benchmark/bin/benchmark-worker
}
#
function configure_benchmark_memory {
sed -i 's/^JVM_MEM=.*$/JVM_MEM=" -Xmx4G"/g' /opt/benchmark/bin/benchmark
}
#
function start_kafka_worker {
  configure_driver
  configure_jms
  configure_worker_memory
  configure_benchmark_memory
  rm -f benchmark-worker.log
until nohup bin/benchmark-worker --port 1130 --stats-port 1131 >kafka_worker.log  2>&1 &
  sleep 1
  pgrep java >/dev/null; do
  echo "Benchmark worker failed to start. Retrying..."
done
for i in {1..60}; do lsof -i :1130 >/dev/null && { echo; echo $(hostname):success; exit 0; } || echo -n .; sleep 1; done;
echo; echo $(hostname):failed; exit 1
}
#
#
#
function stop_kafka_worker {
  echo "Stopping kafka_worker..."
  killall java 1>/dev/null 2>/dev/null || { echo "====Was not running"; }
}
#
#
function status_kafka_worker {
  echo "Checking status kafka_worker..."
  lsof -P -i :1130 || { echo "====Not running"; }
}
#
#
echo "script:info  node:dev.kafkaw-12 omnode:dev.x2-4.kafkaw-2 option:$1 "
case $1 in
     start | start_clean)
     stop_kafka_worker
     start_kafka_worker
     ;;
     stop)
     stop_kafka_worker
     ;;
     status)
     status_kafka_worker
     ;;
     *)
     ;;
esac
